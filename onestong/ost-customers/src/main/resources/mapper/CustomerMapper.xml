<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.ost.customers.dao.CustomerDao">


	<select id="selectByIds" resultType="org.ost.entity.customer.Customer">

		select id,name from tbl_customer tc
		<where>
			tc.id in
			<foreach item="id" collection="ids" open="(" separator=","
				close=")">
				#{id}
			</foreach>
			and isDelete = 0
		</where>
	</select>

	<select id="selectCustomerCount" resultType="java.lang.Integer">
		select
		count(1)
		from tbl_customer
		<where>
			<trim prefixOverrides="AND |OR">
				<if test="customer.name != null and customer.name != ''">
					instr(name,#{customer.name}) > 0
				</if>
				<if test="customer.py != null and customer.py != ''">
					and instr(py,#{customer.py}) > 0
				</if>
				<if test="customer.szm != null and customer.szm != ''">
					and instr(szm,#{customer.szm}) > 0
				</if>
				<if test="keyword != null and keyword !=''">
					and instr(name,#{keyword}) >0
				</if>

				<if test="params != null">
					and
					<foreach item="key" collection="params.keys" open="("
						separator="and" close=")">
						property ->
						'$.${key}' = #{params[${key}],jdbcType=VARCHAR}
					</foreach>

				</if>
				and schemaId = #{customer.schemaId,jdbcType=VARCHAR}
				and isDelete =
				0
			</trim>

		</where>
	</select>




	<select id="selectCustomers" resultType="org.ost.entity.customer.Customer">
		select
		id,
		name,
		py,
		szm,
		parentId,
		property ,
		createTime,
		createBy,
		updateTime,
		isDelete,
		schemaId
		from tbl_customer
		<where>
			<trim prefixOverrides="AND |OR">
				<if test="customer.name != null and customer.name != ''">
					and instr(name,#{customer.name}) > 0
				</if>
				<if test="customer.py != null and customer.py != ''">
					and instr(py,#{customer.py}) > 0
				</if>
				<if test="customer.szm != null and customer.szm != ''">
					and instr(szm,#{customer.szm}) > 0
				</if>
				<if test="keyword != null and keyword != ''">
					and instr(name,#{keyword}) > 0
				</if>
				<if test="paramsMap != null">
					and 
					<foreach item="key" collection="paramsMap.keys" open="("
						separator="and" close=")">
						property ->
						'$.${key}' = #{paramsMap[${key}],jdbcType=VARCHAR}
					</foreach>
				</if>
				and schemaId = #{customer.schemaId,jdbcType=VARCHAR}
				and isDelete =
				0
			</trim>

		</where>
	</select>

	<update id="updateCustomerSelective">
		update tbl_customer
		<set>
			<if test="customer.name != null and customer.name != ''">
				name = #{customer.name},
			</if>
			<if test="customer.property != null">
				property = JSON_SET(property,
				<foreach collection="customer.property.keys" item="key"
					separator=",">
					'$.${key}',#{customer.property[key]}
				</foreach>
				)
			</if>
		</set>
		where id = #{customer.id}
		and schemaId = #{customer.schemaId}
	</update>


	<select id="selectCustomerOrg" resultType="org.ost.entity.customer.org.CustomerOrg">

		select * from tbl_organize_customer toc
		<where>
			toc.customerID in
			<foreach item="customerId" collection="customerIds" open="("
				separator="," close=")">
				#{customerId}
			</foreach>
			and isDelete = 0
		</where>
	</select>


	<select id="selectCustomerUsers" resultType="org.ost.entity.customer.user.UserCustomers">

		select * from tbl_user_customer tuc
		<where>
			tuc.customerID in
			<foreach item="customerId" collection="customerIds" open="("
				separator="," close=")">
				#{customerId}
			</foreach>
			and isDelete = 0
		</where>
	</select>

	<select id="selectByProject" resultType="org.ost.entity.customer.vo.CustomerVo">
		select
		tc.id,
		tc.name
		from tbl_customer tc left join tbl_project_customer
		tpc
		on(tc.schemaID,tc.id) =(tpc.schemaID,tpc.customerID)
		<where>
			tpc.projectID = #{projectId} and tpc.schemaID = #{schemaId}
		</where>
	</select>


</mapper>