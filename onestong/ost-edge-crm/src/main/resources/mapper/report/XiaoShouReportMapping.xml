<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="org.ost.crm.dao.report.XiaoShouReportDao">
    <!-- 终端门店列表 -->
    <select id="searchListCount" resultType="java.lang.Integer">
        SELECT
        count(1)
        <include refid="searchListSQL"></include>
        limit #{page.nextPage} ,#{page.perPageSum}
    </select>

    <select id="searchList" resultType="org.ost.entity.report.dto.XiaoShouReportDto">
        select
        tbl_project.id
        ,tbl_project.name
        ,tbl_project.projectTypeID
        ,tbl_project_type.name as projetTypeName
        ,tbl_project.state
        ,tbl_project.startTime
        ,tbl_project.amount
        ,ifnull((select sum(ifnull(rate,'0')) from tbl_project_payment where projectID = tbl_project.id and state = '1'),'0') as rate
        <include refid="searchListSQL"></include>
        order by tbl_project.startTime,tbl_project.name desc
        limit #{page.nextPage} ,#{page.perPageSum}
    </select>

    <sql id="searchListSQL">
        from tbl_project
        left join tbl_project_type
        on tbl_project_type.id = tbl_project.projectTypeID

        WHERE
        1 = 1
        <if test='params.managerOwnerName != null and params.managerOwnerName != ""'>
            tbl_project.id in (
              select projectID from tbl_user_project where userName like CONCAT('%','${params.managerOwnerName}','%')
            )
        </if>
        <if test='params.projectType != null and params.projectType != ""'>
            and tbl_project.projectTypeID = #{params.projectType}
        </if>
        <if test='params.startDate != null and params.startDate != ""'>
            and tbl_project.startTime >= #{params.startDate}
        </if>
        <if test='params.startDate != null and params.startDate != ""'>
            and tbl_project.startTime &lt;= #{params.endDate}
        </if>
    </sql>
</mapper>