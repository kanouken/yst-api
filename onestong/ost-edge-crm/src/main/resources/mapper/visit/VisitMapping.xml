<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="org.ost.crm.dao.visit.VisitDao">

	<insert id="insertVisitProject">
		insert into tbl_visit_event_project(
		visitEventID,
		projectID,
		createTIme,
		createBy,
		updateTime,
		updateBy,
		isDelete,
		schemaID
		) values

		<foreach collection="vps" item="vp" separator=",">
			(
			#{vp.visitEventID},
			#{vp.projectID},
			#{vp.createTime},
			#{vp.createBy},
			#{vp.updateTime},
			#{vp.updateBy},
			#{vp.isDelete},
			#{vp.schemaId}
			)
		</foreach>

	</insert>

	<delete id="deleteVisitProject">
		delete from tbl_visit_event_project
		where visitEventID
		= #{visitId}
	</delete>


	<insert id="insertVisitSupporter">
		insert into tbl_visit_event_user(
		visitEventID,
		userID,
		userName,
		organizeID,
		organizeName,
		role,
		createTIme,
		createBy,
		updateTime,
		updateBy,
		isDelete,
		schemaID,
		visitContent,
		visitDetail
		) values

		<foreach collection="vps" item="vp" separator=",">
			(
			#{vp.visitEventID},
			#{vp.userID},
			#{vp.userName},
			#{vp.organizeID},
			#{vp.organizeName},
			#{vp.role},
			#{vp.createTime},
			#{vp.createBy},
			#{vp.updateTime},
			#{vp.updateBy},
			#{vp.isDelete},
			#{vp.schemaId},
			#{vp.visitContent},
			#{vp.visitDetail}
			)
		</foreach>

	</insert>

	<insert id="insertVisitApprover">
		insert into tbl_visit_event_approval_user(
		visitEventID,
		userID,
		userName,
		organizeID,
		organizeName,
		role,
		approvalStatus,
		createTIme,
		createBy,
		updateTime,
		updateBy,
		isDelete,
		schemaID
		) values

		<foreach collection="vps" item="vp" separator=",">
			(
			#{vp.visitEventID},
			#{vp.userID},
			#{vp.userName},
			#{vp.organizeID},
			#{vp.organizeName},
			#{vp.role},
			#{vp.approvalStatus},
			#{vp.createTime},
			#{vp.createBy},
			#{vp.updateTime},
			#{vp.updateBy},
			#{vp.isDelete},
			#{vp.schemaId}
			)
		</foreach>

	</insert>

	<select id="selectByCustomer" resultType="org.ost.crm.model.visit.dto.VisitListDto">
		select
		ve.id,
		ve.visitType,
		ve.visitTime,
		ve.customerID customerId,
		ve.customerName,
		pt.`name` busChange
		from tbl_visit_event ve left join

		tbl_project_type pt

		on (ve.schemaID, ve.projectTypeID) = (pt.schemaID, pt.id)

		where ve.isDelete = 0 and ve.schemaID = #{customer.schemaId} and ve.customerID =#{customer.id}
		<if test="params.contactDate != null">
			and date_format(ve.visitTime, '%Y/%m/%d') = #{params.contactDate}
		</if>
		<if test="params.contactType != null">
			and ve.visitType = #{params.contactDate}
		</if>
		<if test="params.createBy != null">
			and ve.createBy = #{params.createBy}
		</if>
		order by ve.createTIme

	</select>
	
	
	<select id="selectCountByCustomer" resultType="java.lang.Integer">
		select
		count(1)
		from tbl_visit_event ve left join

		tbl_project_type pt

		on (ve.schemaID, ve.projectTypeID) = (pt.schemaID, pt.id)

		where ve.isDelete = 0 and ve.schemaID = #{customer.schemaId} and ve.customerID =#{customer.id}
		<if test="params.contactDate != null">
			and date_format(ve.visitTime, '%Y/%m/%d') = #{params.contactDate}
		</if>
		<if test="params.contactType != null">
			and ve.visitType = #{params.contactDate}
		</if>
		<if test="params.createBy != null">
			and ve.createBy = #{params.createBy}
		</if>
	</select>
	

</mapper>